{% extends 'base.html' %}

{% block title %}Map View{% endblock %}

{% block script %}
<link href="https://cdn.jsdelivr.net/gh/gitbrent/bootstrap4- toggle@3.6.1/css/bootstrap4-toggle.min.css" rel="stylesheet">
<script async defer src="https://maps.googleapis.com/maps/api/js?key={{google_key}}&libraries=marker&callback=initMap" type="text/javascript"></script>
<script src="https://cdn.jsdelivr.net/gh/gitbrent/bootstrap4-toggle@3.6.1/js/bootstrap4-toggle.min.js"></script>
<script type="text/javascript" src="{{ url_for('static', filename='javascript/maps/latlng_avg.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='javascript/maps/show_map.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='javascript/maps/add_markers.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='javascript/maps/add_listen_click.js') }}"></script>

<script>
function listen_zoom(map, station, area, full) {
    map.addListener('center_changed', function() {
        console.log('center_change')
    })
    map.addListener('zoom_changed', function() {
        var newZoom = map.getZoom();
        showMap(station, area, full, map.getZoom(), map.getCenter().lat(), map.getCenter().lng())
    });
}
function onLoad(){
    console.log("onLoad in pub_map")
    switch(map_view) {
        case 'all':
            document.getElementById("all_pubs").checked = true;
            break;
        case 'new':
            document.getElementById("new_pubs").checked = true;
            break;
        case 'reviewed':
            document.getElementById("reviewed_pubs").checked = true;
            break;
        }
}
function showMap(station, area, full, zoom, lat, lng){
    console.log('showMap')
    map = show_map(lat, lng, zoom)
    switch (true) {
        case (zoom < 16):
            data = area
            break;
        default:
            data = full
    }

    add_markers(map, zoom, data);
    add_listen_click();
    listen_zoom(map, station, area, full)
}
function initMap(){
    map_view =  {{ map_view | tojson }}
    station = {{ station | tojson }}
    area = {{ area | tojson }}
    full = {{ full | tojson }}
    let { avg_lat, avg_lng } = latlng_avg(area);
    zoom = 13
    showMap(station, area, full, zoom, avg_lat, avg_lng)
}
function all_pubs(){
    location.href = "/pub/map/all";
}
function new_pubs(){
    var lat = map.getCenter().lat()
    var lng = map.getCenter().lat()
    var zoom = map.getZoom()
    location.href="/pub/map/new"
}
function reviewed_pubs(){
    location.href = "/pub/map/reviewed";
}
</script>
{% endblock %}

{% block controls %}
<input type="checkbox" id="all_or_nothing" name="all_or_nothing">
{% endblock %}

{% block main %}
    <div class="col-md-12 mx-auto" id="main">
        <div id="map" style="width:100%; height:450px;"></div>
    </div>
{% endblock %}

{% block centre %}
    <div class="row justify-content-center top-buffer">
        <a class="btn btn-primary" href="{{ url_for('home') }}" role="button">Back to Home</a>
    </div>
    {% include "footer.html" %}
{% endblock %}

{% block navbar_map %}<a class="nav-link active_custom" href="/pub/map/all">Map View</a>{% endblock %}
{% block pub_read_btn %}{% endblock %}
{% block pub_edit_btn %}{% endblock %}
{% block pub_del_btn %}{% endblock %}
{% block rev_read_btn %}{% endblock %}
{% block rev_add_btn %}{% endblock %}
{% block rev_edit_btn %}{% endblock %}
{% block rev_del_btn %}{% endblock %}
{% block search_btn %}{% endblock %}