{% extends 'base.html' %}

{% block title %}Add New Pub{% endblock %}

{% block script %}
<link rel= "stylesheet" type= "text/css" href= "{{ url_for('static',filename='css/check.css') }}">
<link rel= "stylesheet" type= "text/css" href= "{{ url_for('static',filename='css/layout.css') }}">
<script type="text/javascript" src="{{ url_for('static', filename='javascript/maps/latlng_avg.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='javascript/maps/show_map.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='javascript/maps/add_markers.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='javascript/maps/add_listen_click.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='javascript/maps/map_listen_click.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='javascript/maps/map_listen_bounds.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='javascript/maps/listen_events.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='javascript/maps/listen_search.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='javascript/maps/listen_zoom.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='javascript/maps/class_event_handler.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='javascript/maps/mouse_down_click.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='javascript/html/insert_line.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='javascript/html/populate_form.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='javascript/html/star_click.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='javascript/html/feature_click.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='javascript/sum_score.js') }}"></script>
<script>
var js = document.createElement("script");
js.type = "text/javascript";
if ( window.navigator.onLine == true) {
    js.src = 'https://maps.googleapis.com/maps/api/js?key={{google_key}}&libraries=places&callback=initMap'
    document.head.appendChild(js)
} else {
    alert('You appear to offline so maps cannot be displayed')
}
</script>

<script>
    new_id = {{ new_id | tojson }}
    pubs_reviews = {{ pubs_reviews | tojson }}
    summary = {{ summary | tojson }}
    full = {{ full | tojson }}
</script>

<script>
function onLoad(){
    console.log("onLoad in add pub");
    config = {{ config | tojson }}
    pub_fields = config['pub']['column']
    review_fields = config['review']['column']
    pub_review_fields = config['pub']['column'].concat(config['review']['column'])
    input_controls = config['control']['input']
    dropdown_controls = config['control']['dropdown']
    slider_controls = config['control']['slider']
    check_controls = config['control']['check']
    star_controls = config['control']['star']
    score_list = config['review']['score']

    form = {{ form_type | tojson }}
    populate_form(form)
}

function initMap(){

    //if (navigator.geolocation) {
    //    navigator.geolocation.getCurrentPosition(showPosition);
    //} else {
        let { avg_lat, avg_lng } = latlng_avg(pubs_reviews);
    //}
    zoom = 13
    showMap(summary, full, zoom, avg_lat, avg_lng)
}

function showPosition(position) {
    console.log(showPosition)
    const avg_lat = position.coords.latitude
    const avg_lng = position.coords.longitude

}

function showMap(summary, full, zoom, lat, lng){
    console.log('showMap')
    console.log('zoom: ' + zoom)
    map = show_map(lat, lng, zoom)
    key = {{ google_key | tojson }}
    stations = {{ stations | tojson }}
    areas = {{ areas | tojson }}
    data = full
    add_markers(map, zoom, data);
    var class_event_handler = new ClickEventHandler(map, origin, key, stations, areas);
    const input = document.getElementById("search-input-navbar");
    const searchBox = new google.maps.places.SearchBox(input);
    //add_listen_click();
    map_listen_click(map, stations, areas);
    listen_search(map, searchBox);
    map_listen_bounds(map, searchBox, stations, areas);
    function isIconMouseEvent(e) {
        console.log("place icon clicked")
        return "placeId" in e;
    }
}

</script>
{% endblock %}

{% block main %}
<div class="col center-block">
    <div class="row">
        <div id="map" class="map_height"></div>
    </div>
    <div class="row">
        <input id="search-input-navbar" class="form-control mr-sm-2" type="search" placeholder="Search" aria-label="Search">
    </div>
    <div class="row justify-content-center align-items-center">
        <form action="{{ url_for('pub_read', pub_id=new_id) }}" method="post">
            {% include "pub_form_refactored.html" %}
            <div class="form-group row" style="margin: 15px 0;">
                <button id="submit" type="submit" class="btn btn-primary btn-block" name="submit" value="submit" disabled>Submit</button>
                <div id="submit_message" class="font-size: 8px; text-align: center"><i>Click venue on map before submitting</i></div>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block centre %}
    <div class="row justify-content-center top-buffer" style="display: flex; align-items: center;">
        <a class="btn btn-primary" href="{{ url_for('home') }}" role="button">Back to Home</a>
    </div>
    <div class="row top-buffer" style="border-top: 1px solid;"></div>
    <div class="row top-buffer">
        {% include "footer.html" %}
    </div>
{% endblock %}
