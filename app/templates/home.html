{% extends 'base.html' %}

{% block title %}Home{% endblock %}

{% block script %}
<!--<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>-->
<!--<script src="https://apis.google.com/js/api.js" type="text/javascript"></script>-->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel= "stylesheet" type= "text/css" href= "{{ url_for('static',filename='css/layout.css') }}">
<script type="text/javascript" src="{{ url_for('static', filename='javascript/crawl/distancing.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='javascript/crawl/display.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='javascript/crawl/display_none.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='javascript/crawl/show_map_home.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='javascript/html/populate_table.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='javascript/html/feature_click.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='javascript/html/feature_search.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='javascript/maps/add_map_click.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='javascript/maps/add_markers.js') }}"></script>
<!--<script type="text/javascript" src="{{ url_for('static', filename='javascript/maps/map_setup.js') }}"></script>-->

<script>
key = {{ google_key | tojson }}
pubs = {{ pubs | tojson }}
pub = {{ pub | tojson }}
start = {{ start | tojson }}
walk = {{ walk | tojson }}
favourite = {{ favourite | tojson }}
stops = {{ stops | tojson }}
criteria = {{ criteria | tojson }}
counter = {{ counter | tojson }}


function mapSetup() {
    crawl = { start, walk, favourite, stops, criteria }
    var stop_offs = []
    /*
    if ( crawl.favourite = 'all' ) {
        crawl.score = pub[0]['score']
        crawl.score_name = 'Rating'
    } else {
        crawl.score = pub[0][favourite]
        crawl.score_name = favourite
    }
    */
    pub_first_stop = {
        name: pub[0]['name'],
        distance_from_first: 0,
        distance_next: 0,
        rank: pub[0]['rank'],
        //score: pub[0]['score'],
        //star: pub[0]['star'],
        //star_score: pub[0][pub[0]['star']],
        lat: pub[0]['latitude'],
        lng: pub[0]['longitude'],
        place: pub[0]['place'],
        pub_identity: pubs[0]['pub_identity']
    }
    pubs = pubs.filter (obj => !(obj.place == pub_first_stop.place))
    if ( crawl.favourite != 'all' ) {
        pubs = pubs.filter (obj => (obj[crawl.favourite] === true))
    }
    if (pubs.length > 0 ) {
        stop_offs.push(pub_first_stop)
        for (let i=0; i<crawl.stops; i++) {
            list_got = distancing(pub_first_stop, stop_offs[i], pubs, crawl)
            if ( list_got === undefined ) {
                break;
            } else {
                stop_offs.push(list_got)
                pubs = pubs.filter (obj => !(obj.place == list_got.place))
            }
        }
        displayCrawl(stop_offs, 'map');
    } else {
        displayNone(pub_first_stop);
    }
    var myOptions = {
        zoom: 14,
        center: new google.maps.LatLng(51.52302856214283,-0.1070362329483032),
        mapTypeId: google.maps.MapTypeId.ROADMAP,
        zoomControl: false,
        streetViewControl: false,
        disableDefaultUI: true
    }
    map2 = new google.maps.Map(document.getElementById("map2"), myOptions)
    map2.addListener("click", (event) => {
        console.log('you clicked on the map')
        event.stop();
        window.location.href = "/pub/map/all"
    });
    add_markers(map2, 16, pubs, Boolean(false));
}
</script>

<script>
function onLoad(){
    features = {{ features | tojson }}
    form = {{ form_type | tojson }}
    var photo_array = {{ photo_array | tojson }}
    var map_lat = {{ map_lat | tojson }}
    var map_lng = {{ map_lng | tojson }}
    var map_view = {{ map_view | tojson }}
    var config = {{ config | tojson }}
    var areas = {{ areas | tojson }}
    var pubs_reviews = {{ pubs_reviews | tojson }}
    var photo_id = {{ photo_id | tojson }}
    var js = document.createElement("script");
    js.type = "text/javascript";
    if ( window.navigator.onLine == true) {
        js.src = 'https://maps.googleapis.com/maps/api/js?key={{google_key}}&libraries=places&callback=mapSetup'
        document.head.appendChild(js)
    } else {
        //alert('You appear to offline so maps cannot be displayed')
    }
    config2 = {{ config2 | tojson }}

}
</script>
{% endblock %}

{% block main %}
<div class="col-md-12 mx-auto" id="main">
    {% include "home_intro.html" %}
    {% include "home_crawl.html" %}
    <div class="row top-buffer">
        <div class="col-12 center-block text-center">
            <a style="font-weight: bold; font-size: 16px; color: #000000; text-decoration: none; padding: 5px 0 0 0">Search pubs by feature</a>
        </div>
    </div>
    <div class="row" style="display:flex; align-items:center; border-color:#0275d8; border-style:solid; background-color:#D3D3D3; border-width:thin">
        {% with auto_exec='off' %}
            {% include "home_features.html" %}
        {% endwith %}
    </div>
    <div class="row" style="background-color: #0275d8">
        <div class="col-12 center-block text-center">
            <a onclick="featureSearch(features)" style="font-weight: bold; font-size: 14px; color: white;">Search</a>
        </div>
    </div>
    {% include "home_area.html" %}
    {% include "home_location.html" %}

</div>
{% endblock %}

{% block counter %}
    <div class="body counter">
        <div id="digit_100000" class="span"></div>
        <div id="digit_10000" class="span"></div>
        <div id="digit_1000" class="span"></div>
        <div id="digit_100" class="span"></div>
        <div id="digit_10" class="span"></div>
        <div id="digit_1" class="span"></div>
    </div>
    <div class="message">Unique Visits to this Page: </div>
    <h3><span id="visits"></span></h3>
{% endblock %}