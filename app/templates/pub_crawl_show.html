{% extends 'base.html' %}

{% block title %}Pub Crawls Showing{% endblock %}

{% block script %}
<script async defer src="https://maps.googleapis.com/maps/api/js?key={{google_key}}&libraries=marker&callback=initMap" type="text/javascript"></script>
<script type="text/javascript" src="{{ url_for('static', filename='javascript/maps/show_map.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='javascript/maps/latlng_avg.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='javascript/html/populate_table.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='javascript/crawl/distancing.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='javascript/crawl/display.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='javascript/crawl/display_none.js') }}"></script>
<script>
var duration = 0;
function onLoad(){
    console.log("onLoad in pub_crawl_show")
    var header_listing = String(crawl.favourite['0']).toUpperCase() + String(crawl.favourite).substring(1)
    document.getElementById("header_listing").innerHTML = "<h2>" + header_listing + " pub crawl</h2>"

}
function initMap(){
    key = {{ google_key | tojson }}
    station = {{ station | tojson }}
    pubs = {{ pubs | tojson }}
    pub = {{ pub | tojson }}
    crawl = {
        start: {{ start | tojson }},
        walk: {{ walk | tojson }},
        favourite: {{ favourite | tojson }},
        stops: {{ stops | tojson }},
        criteria: {{ criteria | tojson }}
    }
    var stop_offs = []
    if ( crawl.favourite = 'all' ) {
        crawl.score = pub[0]['score']
        crawl.score_name = 'Rating'
    } else {
        crawl.score = pub[0][favourite]
        crawl.score_name = favourite
    }
    pub_first_stop = {
        name: pub[0]['name'],
        distance_from_first: 0,
        distance_next: 0,
        score: pub[0]['score'],
        star: pub[0]['star'],
        star_score: pub[0][pub[0]['star']],
        lat: pub[0]['latitude'],
        lng: pub[0]['longitude'],
        place: pub[0]['place'],
        pub_identity: pubs[0]['pub_identity']
    }
    pubs = pubs.filter (obj => !(obj.place == pub_first_stop.place))
    if ( crawl.favourite != 'all' ) {
        pubs = pubs.filter (obj => (obj[crawl.favourite] === true))
    }
    if (pubs.length > 0 ) {
        stop_offs.push(pub_first_stop)
        for (let i=0; i<crawl.stops; i++) {
            list_got = distancing(pub_first_stop, stop_offs[i], pubs, crawl)
            if ( list_got === undefined ) {
                break;
            } else {
                stop_offs.push(list_got)
                pubs = pubs.filter (obj => !(obj.place == list_got.place))
            }
        }
        displayCrawl(stop_offs);
    } else {
        displayNone(pub_first_stop);
    }
}
</script>

{% endblock %}

{% block main %}
    <div id="header_listing"></div>
    {% include "footer.html" %}
{% endblock %}

{% block left %}
<div id="map" style="width:100%; height:200px;"></div>
{% endblock %}

{% block right %}
<div class="col">
    <div class="row" id="route"></div>
</div>
{% endblock %}

{% block navbar_crawls %}<a class="nav-link active_custom" href="/pub/crawl">Pub Crawls</a>{% endblock %}
{% block pub_read_btn %}{% endblock %}
{% block pub_edit_btn %}{% endblock %}
{% block pub_del_btn %}{% endblock %}
{% block rev_read_btn %}{% endblock %}
{% block rev_add_btn %}{% endblock %}
{% block rev_edit_btn %}{% endblock %}
{% block rev_del_btn %}{% endblock %}
{% block search_btn %}{% endblock %}
