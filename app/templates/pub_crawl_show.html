{% extends 'navbar.html' %}

{% block title %}Pub Crawls Showing{% endblock %}

{% block script %}
<script async defer src="https://maps.googleapis.com/maps/api/js?key={{google_key}}&libraries=marker&callback=initMap" type="text/javascript"></script>
<script type="text/javascript" src="{{ url_for('static', filename='javascript/show_map.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='javascript/latlng_avg.js') }}"></script>
<script>
function onLoad(){
    console.log("onLoad in pub_crawl_show")
}
function initMap(){
    pubs = {{ pubs | tojson }}
    key = {{ google_key | tojson }}
    station = {{ station | tojson }}
    start = {{ start | tojson }}
    walk = {{ walk | tojson }}
    favourite = {{ favourite | tojson }}
    stops = {{ stops | tojson }}
    criteria = {{ criteria | tojson }}
    pubs = {{ pubs | tojson }}
    pub = {{ pub | tojson }}
    var stop_offs = []

    pub_stop_obj = { name: pub[0]['name'], place: pub[0]['place'], lat: pub[0]['latitude'], lng: pub[0]['longitude'], distance: 0}
    pubs = pubs.filter (obj => !(obj.place == pub_stop_obj.place))
    stop_offs.push(pub_stop_obj)
    for (let i=0; i<stops-1; i++) {
        list_got = distancing(stop_offs[i].lat, stop_offs[i].lng, pubs)
        stop_offs.push(list_got)
        pubs = pubs.filter (obj => !(obj.place == list_got.place))
    }
    pubCrawl(stop_offs)

}


function distancing(lat, lng, pubs) {
    records = []
    for (let i = 0; i < pubs.length; i++) {
        lat_diff = Math.abs(pubs[i]['latitude'] - lat)
        lng_diff = Math.abs(pubs[i]['longitude'] - lng)
        tot_diff = lat_diff + lng_diff
        var record = { name: pubs[i]['name'], place: pubs[i]['place'], lat: pubs[i]['latitude'], lng: pubs[i]['longitude'], distance: tot_diff}
        records.push(record);
    }
    records = records.sort((a, b) => {
        if (a.distance < b.distance) {
            return -1;
        }
    });
    return records[0]
}

function populate_table(stop_offs, duration_array) {
    console.log(pubs)
    const result = [];
    for (const stop of stop_offs) {
        var newArray = pubs.filter(function (el) {
              return el.place == stop.place_id;
            });
        console.log(newArray)
        const pub = pubs.filter (obj => (obj.place === stop.place_id))
        result.push({
            name: newArray.name,
            place: stop.place_id
        });
    }
    console.log(result)
    letters = ['A','B','C','D','E','F','G','H','I','J']
    duration_array.unshift(0)
    table_string = '<table id="pub_list" class="table table-striped">'
    table_string += '<thead><tr>' +
                        '<th>Stop</th>' +
                        '<th>Name</th>' +
                        '<th>Walking Time</th>' +
                        '</tr></thead>'
    for (let i=0; i< stop_offs.length; i++) {
        if (Math.floor(duration_array[i]/60) == 0) {
            min_calc = ''
        } else {
            min_calc = Math.floor(duration_array[i]/60) + 'min '
        }
        sec_calc = duration_array[i] - (Math.floor(duration_array[i]/60))*60
        if (sec_calc == 0) {
            secs_calc = ''
        } else {
            secs_calc = (duration_array[i] - (Math.floor(duration_array[i]/60))*60) + 'sec'
        }
        table_string += '<tr>' +
            '<td>' + letters[i] + '</td>' +
            '<td>' + stop_offs[i].place_id + '</td>' +
            '<td>' + min_calc + secs_calc +'</td>' +
            '</tr>'
    }
    table_string += '</table>'
    document.getElementById('route').innerHTML = table_string
}

function pubCrawl(stop_offs) {
    var directionsService = new google.maps.DirectionsService();
    var directionsRenderer = new google.maps.DirectionsRenderer();


    var map = new google.maps.Map(document.getElementById('map'), {
        zoom:7,
        mapTypeId: google.maps.MapTypeId.ROADMAP
    });

    directionsRenderer.setMap(map);
    var request = {
        origin: {placeId: stop_offs[0].place},
        destination: {placeId: stop_offs[stop_offs.length-1].place},
        optimizeWaypoints: true,
        travelMode: google.maps.DirectionsTravelMode.WALKING
    };
    ways = []
    for (let i=1; i<stop_offs.length-1; i++) {
        ways.push({stopover: true, location: { placeId: stop_offs[i].place }})
    }
    request["waypoints"] = ways
    directionsService.route(request, function(response, status) {
        var no_of_legs = response.routes[0].legs.length
        if (status == google.maps.DirectionsStatus.OK) {
            var optimised_route = response.geocoded_waypoints
            duration_array = []
            for (let i = 0; i < response.routes[0].legs.length; i++) {
                var duration = response.routes[0].legs[i].duration.value
                duration_array.push(duration)
            }
            populate_table(optimised_route, duration_array)
            directionsRenderer.setDirections(response);
        }

    });
}
</script>

{% endblock %}

{% block full_screen %}

{% endblock %}

{% block form %}
<div id="map" style="width:100%; height:450px;"></div>
{% endblock %}

{% block image %}
<div class="col">
    <div class="row" id="route"></div>
</div>
{% endblock %}

{% block navbar_crawls %}<a class="nav-link active_custom" href="/pub/crawl">Pub Crawls</a>{% endblock %}
{% block pub_read_btn %}{% endblock %}
{% block pub_edit_btn %}{% endblock %}
{% block pub_del_btn %}{% endblock %}
{% block rev_read_btn %}{% endblock %}
{% block rev_add_btn %}{% endblock %}
{% block rev_edit_btn %}{% endblock %}
{% block rev_del_btn %}{% endblock %}
{% block search_btn %}{% endblock %}