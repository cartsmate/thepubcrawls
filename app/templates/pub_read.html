{% extends 'base.html' %}

{% block title %}Pub Details{% endblock %}

{% block script %}
<link rel= "stylesheet" type= "text/css" href= "{{ url_for('static',filename='css/check.css') }}">
<link rel= "stylesheet" type= "text/css" href= "{{ url_for('static',filename='css/layout.css') }}">
<script type="text/javascript" src="{{ url_for('static', filename='javascript/maps/latlng_avg.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='javascript/maps/show_map.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='javascript/maps/add_markers.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='javascript/maps/add_listen_click.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='javascript/maps/map_listen_click.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='javascript/maps/map_listen_bounds.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='javascript/maps/listen_events.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='javascript/maps/listen_search.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='javascript/maps/listen_zoom.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='javascript/maps/class_event_handler.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='javascript/maps/mouse_down_click.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='javascript/html/insert_line.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='javascript/html/populate_form.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='javascript/html/shade_stars.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='javascript/html/star_click.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='javascript/html/edit_click.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='javascript/html/feature_click.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='javascript/html/go_add.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='javascript/html/go_station.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='javascript/html/station_click.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='javascript/sum_score.js') }}"></script>

<!--
<script type="text/javascript" src="{{ url_for('static', filename='javascript/maps/listen_click_off.js') }}"></script>
-->
<script>form_type = {{ form_type | tojson }}</script>

<script>

</script>

<style>
.horizontal-gradient {
    background: linear-gradient(to right, blue, pink);
}
.top-buffer {
    margin-top:20px;
}
.andy_width {
    width: 100%
}
.checked {
    color: yellow;
}
</style>

<script>
function onLoad(){

    //alert({{response}})
    console.log("onLoad in pub_read");
    form_type = {{ form_type | tojson }}
    config2 = {{config2 | tojson }}
    pub_review = {{ pub_review | tojson }}
    input_list = {{ input_list | tojson }}
    dropdown_list = {{ dropdown_list | tojson }}
    slider_list = {{ slider_list | tojson }}
    check_list = {{ check_list | tojson }}
    //console.log(check_list)
    date_controls = {{ date_list | tojson }}
    star_list = {{ star_list | tojson }}

    form_visible_list = {{ form_visible_list | tojson }}
    required_list = {{ required_list | tojson }}

    fields_list = {{ fields_list | tojson }}

    alias_list = {{ alias_list | tojson }}
    icon_list = {{ icon_list | tojson }}

    var js = document.createElement("script");
    js.type = "text/javascript";
    if ( window.navigator.onLine == true) {
        console.log('outside of function')
        js.src = 'https://maps.googleapis.com/maps/api/js?key={{google_key}}&libraries=places&callback=initMap'
        document.head.appendChild(js)
    } else {
        //alert('You appear to offline so maps cannot be displayed')
    }

    populate_form(form_type);
}

function initMap(){
    console.log("initMap in pub_read");
    zoom = 13
    form_type = {{ form_type | tojson }}

    if (form_type == 'add') {
        data = {{pubs_reviews | tojson}}
    } else {
        data = {{pub_review | tojson}}
    }
    showMap(data, zoom, {{map_lat}}, {{map_lng}})
}

function showMap(data, zoom, lat, lng){
    console.log('showMap')
    map = show_map(lat, lng, zoom)
    key = {{ google_key | tojson }}
    data = {{pubs_reviews | tojson}}
    stations = {{stations | tojson}}
    areas = {{areas | tojson}}
    add_markers(map, zoom, data);
    if (form_type == 'read' || form_type == 'list'){
        add_listen_click(map);
    }
    /*
    map.setCenter({ lat: 0, lng: 0 });
    */
    if (form_type == 'add') {
        var class_event_handler = new ClickEventHandler(map, origin, key, data);
        const input = document.getElementById("search-input-navbar");
        const searchBox = new google.maps.places.SearchBox(input);
        listen_search(map, searchBox);
        map_listen_bounds(map, searchBox, data);
    }
    if (form_type == 'add' || form_type == 'edit') {
        listen_events(lat, lng, data)
        map_listen_click(map, data)
        function isIconMouseEvent(e) {
            console.log("place icon clicked")
            return "placeId" in e;
        }
    }
    const center = new google.maps.LatLng(lat, lng);
    // using global variable:
    console.log('lat: ' + lat)
    console.log('lng: ' + lng)
    window.map.panTo(center);
}
</script>
{% endblock %}

{% block main %}
<div class="col-md-12 center-block text-center" style="background-color: #0275d8">
    <div style="font-weight: bold; font-size: 20px; color: white; text-decoration: none; padding: 5px 0 0 0">{{pub_review[0]['pub_name']}}</div>
    {% with messages = get_flashed_messages() %}
        {% if messages %}
            {% for message in messages %}
                <div style="font-weight: bold">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}
</div>
{% endblock %}

{% block left %}
    <div class="row">
        <div id="map" class="map_height"></div>
    </div>
    {% if form_type == 'add' %}
        <div class="row">
            <input id="search-input-navbar" class="form-control mr-sm-2" type="search" placeholder="Search" aria-label="Search">
        </div>
    {% endif %}
{% endblock %}


{% block centre %}
<div class="col-md-12 mx-auto" id="main">
    <div class="row justify-content-center align-items-center">
        <form action="{{ url_for('pub_read', pub_id=pub_review[0]['pub_identity']) }}" method="post">
            {% include "pub_form.html" %}

            <div class="form-group row" style="display: flex; align-items: center; background-color:#CDCDCD; border-style:solid; background-color:#D3D3D3; border-width:thin">
                {% with auto_exec='off' %}
                    {% include "home_features.html" %}
                {% endwith %}
            </div>
            <div class="form-group row" style="margin: 15px 0;">
                {% if form_type == 'add' %}
                    <button id="submit" type="submit" class="btn btn-primary btn-block" name="submit" value="submit" disabled>Submit</button>
                    <div id="submit_message" class="font-size: 8px; text-align: center"><i>Click venue on map before submitting</i></div>
                    <div href="{{url_for('pub_read', pub_id=pub_review[0]['pub_identity'])}}" style="color:#d9534f">Cancel</div>
                {% elif form_type == 'edit' %}
                    <button id="submit" type="submit" class="btn btn-primary btn-block" name="submit" value="submit">Submit</button>
                    <div style="display:none;" id="submit_message" class="font-size: 8px; text-align: center"><i>Click venue on map before submitting</i></div>
                    <div href="{{url_for('pub_read', pub_id=pub_review[0]['pub_identity'])}}" style="color:#d9534f">Cancel</div>
                {% else %}
                    <button style="display:none;" id="submit" type="submit" class="btn btn-primary btn-block" name="submit" value="submit">Submit</button>
                    <div style="display:none;" id="submit_message" class="font-size: 8px; text-align: center"><i>Click venue on map before submitting</i></div>
                    <div style="display:none;" href="{{url_for('pub_read', pub_id=pub_review[0]['pub_identity'])}}" style="color:#d9534f">Cancel</div>
                {% endif %}
            </div>
        </form>
    </div>
</div>
{% endblock %}
