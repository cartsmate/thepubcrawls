{% extends 'navbar.html' %}

{% block title %}Pub Crawls Showing{% endblock %}

{% block script %}
<script async defer src="https://maps.googleapis.com/maps/api/js?key={{google_key}}&libraries=marker&callback=initMap" type="text/javascript"></script>
<script type="text/javascript" src="{{ url_for('static', filename='javascript/show_map.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='javascript/latlng_avg.js') }}"></script>
<script>
var duration = 0;
function onLoad(){
    console.log("onLoad in pub_crawl_show")
    var header_listing = String(favourite['0']).toUpperCase() + String(favourite).substring(1)
    document.getElementById("header_listing").innerHTML = "<h2>" + header_listing + " pub crawl</h2>"
}
function initMap(){
    key = {{ google_key | tojson }}
    station = {{ station | tojson }}
    start = {{ start | tojson }}
    walk = {{ walk | tojson }}
    favourite = {{ favourite | tojson }}
    stops = {{ stops | tojson }}
    criteria = {{ criteria | tojson }}
    pubs = {{ pubs | tojson }}
    pub = {{ pub | tojson }}
    var stop_offs = []
    // start pub //
    console.log(favourite)
    if ( favourite = "" ) {
        var favourite_score = pub[0]['score']
        var favourite_name = 'Score'
    } else {
        var favourite_score = pub[0][favourite]
        var favourite_name = favourite
    }
    pub_stop_obj = {
        name: pub[0]['name'],
        place: pub[0]['place'],
        lat: pub[0]['latitude'],
        lng: pub[0]['longitude'],
        score: pub[0]['score'],
        star: pub[0]['star'],
        star_score: pub[0][pub[0]['star']],
        favourite: favourite_name,
        favourite_score: favourite_score,
        distance: 0,
        walk: walk,
        walk_limit: 0
    }
    pubs = pubs.filter (obj => !(obj.place == pub_stop_obj.place))
    pubs = pubs.filter (obj => (obj[favourite] >= 7 || obj['star'] == favourite))

    if (pubs.length > 0 ) {
        stop_offs.push(pub_stop_obj)
        for (let i=0; i<stops-1; i++) {
            list_got = distancing(stop_offs[i].lat, stop_offs[i].lng, pubs, favourite, walk)
            if ( list_got === undefined ) {
            //if ( Object.keys(list_got).length = 0 ) {
                break;
            } else {
                stop_offs.push(list_got)
                pubs = pubs.filter (obj => !(obj.place == list_got.place))
            }
        }
        pubCrawl(stop_offs);
    } else {
        noCrawl(pub_stop_obj);
    }
}

function noCrawl(pub_stop_obj) {
    table_string = '<table id="pub_list" class="table table-striped">'
    table_string += '<thead><tr>' +
                        '<th>Stop</th>' +
                        '<th>Name</th>' +
                        '<th>{{favourite}}</th>' +
                        '<th>Walk</th>' +
                    '</tr></thead>'
    table_string += '<tr>' +
        '<td>A</td>' +
        '<td>' + pub[0]['name'] + '</td>' +
        '<td>' + pub[0].favourite_score + '</td>' +
        '<td></td>' +
                    '</tr>'
    table_string += '<tr>' +
        '<td>-</td>' +
        '<td>No pub crawls fit that criteria</td>' +
        '<td></td>' +
        '<td></td>' +
                    '</tr>'
    table_string += '</table>'
    document.getElementById('route').innerHTML = table_string
}

function distancing(lat, lng, pubs, favourite, walk) {
    records = []
    for (let i = 0; i < pubs.length; i++) {
        lat_diff = Math.abs(pubs[i]['latitude'] - lat)
        lng_diff = Math.abs(pubs[i]['longitude'] - lng)
        tot_diff = lat_diff + lng_diff
        if ( walk != 0 ) {
            var walk_limit = walk * 0.0007
            if (tot_diff < walk_limit) {
                if ( favourite = "" ) {
                    var favourite_score = pubs[i]['score']
                    var favourite_name = 'Score'
                } else {
                    var favourite_score = pubs[i][favourite]
                    var favourite_name = favourite
                }
                var record = {
                    name: pubs[i]['name'],
                    place: pubs[i]['place'],
                    lat: pubs[i]['latitude'],
                    lng: pubs[i]['longitude'],
                    score: pubs[i]['score'],
                    star: pubs[i]['star'],
                    star_score: pubs[i][pubs[i]['star']],
                    favourite: favourite_name,
                    favourite_score: favourite_score,
                    distance: tot_diff,
                    walk: walk,
                    walk_limit: walk_limit
                }
                records.push(record);
            }
        } else {
            if ( favourite = "" ) {
                var favourite_score = pubs[i]['score']
                var favourite_name = 'Score'
            } else {
                var favourite_score = pubs[i][favourite]
                var favourite_name = favourite
            }
            var record = {
                name: pubs[i]['name'],
                place: pubs[i]['place'],
                lat: pubs[i]['latitude'],
                lng: pubs[i]['longitude'],
                score: pubs[i]['score'],
                star: pubs[i]['star'],
                star_score: pubs[i][pubs[i]['star']],
                favourite: favourite_name,
                favourite_score: favourite_score,
                distance: tot_diff,
                walk: walk,
                walk_limit: walk_limit
            }
            records.push(record);
        }

    }
    if ( criteria == 'NEAREST' ) {
        console.log('nearest')
        records = records.sort((a, b) => {
            if (a.distance < b.distance) {
                return -1;
            }
        });
    } else {
    console.log('highest rated')
        records = records.sort((a, b) => {
            if (a.score > b.score) {
                return -1;
            }
        });
    }
    console.log(records)
    return records[0]
}

function pubCrawl(stop_offs) {
    var directionsService = new google.maps.DirectionsService();
    var directionsRenderer = new google.maps.DirectionsRenderer();

    var map = new google.maps.Map(document.getElementById('map'), {
        zoom:7,
        mapTypeId: google.maps.MapTypeId.ROADMAP
    });

    directionsRenderer.setMap(map);
    var request = {
        origin: {placeId: stop_offs[0].place},
        destination: {placeId: stop_offs[stop_offs.length-1].place},
        optimizeWaypoints: true,
        travelMode: google.maps.DirectionsTravelMode.WALKING
    };
    ways = []
    /*
    if (stop_offs.length > 1) {
        destination: {placeId: stop_offs[stop_offs.length-1].place}
    }
    */
    if (stop_offs.length > 2) {
        for (let i=1; i<stop_offs.length-1; i++) {
            ways.push({stopover: true, location: { placeId: stop_offs[i].place }})
        }
        request["waypoints"] = ways
    }
    directionsService.route(request, function(response, status) {
        var no_of_legs = response.routes[0].legs.length
        if (status == google.maps.DirectionsStatus.OK) {
            var optimised_route = response.geocoded_waypoints
            optimised_route[0]['duration'] = 0
            for (let i = 0; i < response.routes[0].legs.length; i++) {
                var duration = response.routes[0].legs[i].duration.value
                optimised_route[i+1]['duration'] = duration
            }
            let merged = stop_offs.map((item, i) => Object.assign({}, item, optimised_route[i]));

            populate_table(merged)
            directionsRenderer.setDirections(response);
        }

    });
}

function populate_table(stop_offs) {
    const result = [];
    for (const stop of stop_offs) {
        var newArray = pubs.filter(function (el) {
              return el.place == stop.place_id;
            });
        const pub = pubs.filter (obj => (obj.place === stop.place_id))
        result.push({
            name: newArray.name,
            place: stop.place_id
        });
    }
    letters = ['A','B','C','D','E','F','G','H','I','J']
    //var fav_caps = String("{{favourite}}").toUpperCase() + String("{{favourite}}").substring(1)
    table_string = '<table id="pub_list" class="table table-striped">'
    table_string += '<thead><tr>' +
                        '<th>Stop</th>' +
                        '<th>Name</th>' +
                        '<th>{{favourite}}</th>' +
                        '<th>Score</th>' +
                        '<th>Walk</th>' +
                        '</tr></thead>'
    for (let i=0; i< stop_offs.length; i++) {
        if (Math.ceil(stop_offs[i]['duration']/60) == 0) {
            min_calc = ''
        } else {
            min_calc = Math.ceil(stop_offs[i]['duration']/60) + 'min '
        }
        sec_calc = stop_offs[i]['duration'] - (Math.floor(stop_offs[i]['duration']/60))*60
        if (sec_calc == 0) {
            secs_calc = ''
        } else {
            secs_calc = (stop_offs[i]['duration'] - (Math.floor(stop_offs[i]['duration']/60))*60) + 'sec'
        }
        table_string += '<tr>' +
            '<td>' + letters[i] + '</td>' +
            '<td>' + stop_offs[i]['name'] + '</td>' +
            '<td>' + stop_offs[i].favourite_score + '</td>' +
            '<td>' + stop_offs[i].score + '</td>' +
            '<td>' + min_calc + '</td>' +
            '</tr>'
    }
    table_string += '</table>'
    document.getElementById('route').innerHTML = table_string
}

</script>

{% endblock %}

{% block full_screen %}
<div id="header_listing"></div>
<!--<div class="col">-->
<!--    <div class="row" id="start">{{start}}</div>-->
<!--    <div class="row" id="walk">{{walk}}</div>-->
<!--    <div class="row" id="favourite">{{favourite}}</div>-->
<!--    <div class="row" id="stops">{{stops}}</div>-->
<!--    <div class="row" id="criteria">{{criteria}}</div>-->
<!--</div>-->
{% endblock %}

{% block form %}

<div id="map" style="width:100%; height:450px;"></div>
{% endblock %}

{% block image %}
<div class="col">
    <div class="row" id="route"></div>
</div>
{% endblock %}

{% block navbar_crawls %}<a class="nav-link active_custom" href="/pub/crawl">Pub Crawls</a>{% endblock %}
{% block pub_read_btn %}{% endblock %}
{% block pub_edit_btn %}{% endblock %}
{% block pub_del_btn %}{% endblock %}
{% block rev_read_btn %}{% endblock %}
{% block rev_add_btn %}{% endblock %}
{% block rev_edit_btn %}{% endblock %}
{% block rev_del_btn %}{% endblock %}
{% block search_btn %}{% endblock %}